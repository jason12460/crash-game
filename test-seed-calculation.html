<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seed Calculation Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a2e;
      color: #fff;
    }
    .result {
      background: #16213e;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 3px solid #00aaff;
    }
    .success {
      border-left-color: #00ff00;
    }
    .error {
      border-left-color: #ff0000;
    }
    code {
      background: rgba(0,0,0,0.3);
      padding: 2px 5px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h1>Provably Fair Seed Calculation Test</h1>
  <div id="output"></div>

  <script type="module">
    // Import functions (we'll inline them for testing)

    // seedToRandom function
    function seedToRandom(seed) {
      const hexValue = seed.slice(0, 13);
      const numValue = parseInt(hexValue, 16);
      const maxValue = Math.pow(2, 52);
      const random = numValue / maxValue;
      return Math.max(0.0001, Math.min(0.9999, random));
    }

    // calculateCrashPoint function
    function calculateCrashPoint(randomValue, rtpFactor = 0.97) {
      if (randomValue <= 0 || randomValue >= 1) {
        throw new Error('Random value must be in range (0, 1)');
      }
      if (rtpFactor <= 0 || rtpFactor > 1) {
        throw new Error('RTP factor must be in range (0, 1]');
      }
      const crashPoint = rtpFactor / (1 - randomValue);
      return Math.min(Math.max(crashPoint, 1.00), 10000);
    }

    // hashSeed function
    async function hashSeed(seed) {
      const encoder = new TextEncoder();
      const data = encoder.encode(seed);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const output = document.getElementById('output');

    function log(message, className = '') {
      const div = document.createElement('div');
      div.className = 'result ' + className;
      div.innerHTML = message;
      output.appendChild(div);
    }

    async function runTest() {
      log('<h2>Test 1: Basic Calculation</h2>');

      // Test seed
      const testSeed = 'a1b2c3d4e5f6789012345678abcdef00';
      log(`Test Seed: <code>${testSeed}</code>`);

      // Calculate hash
      const hash = await hashSeed(testSeed);
      log(`SHA-256 Hash: <code>${hash}</code>`);

      // Convert seed to random
      const random = seedToRandom(testSeed);
      log(`Random Value (from seed): <code>${random}</code>`);

      // Calculate crash point with default RTP (0.97)
      const crashPoint = calculateCrashPoint(random, 0.97);
      log(`Crash Point (RTP=0.97): <code>${crashPoint.toFixed(2)}x</code>`, 'success');

      // Verify calculation manually
      const manualCrash = 0.97 / (1 - random);
      log(`Manual Calculation: 0.97 / (1 - ${random}) = <code>${manualCrash.toFixed(2)}x</code>`);

      if (Math.abs(crashPoint - manualCrash) < 0.01) {
        log('✓ Calculation matches!', 'success');
      } else {
        log('✗ Calculation mismatch!', 'error');
      }

      log('<h2>Test 2: Different RTP Values</h2>');

      const rtpValues = [0.90, 0.95, 0.97, 0.99];
      for (const rtp of rtpValues) {
        const cp = calculateCrashPoint(random, rtp);
        log(`RTP=${rtp}: Crash Point = <code>${cp.toFixed(2)}x</code>`);
      }

      log('<h2>Test 3: Edge Cases</h2>');

      // Very low random value (should give high crash point)
      const lowRandom = 0.0001;
      const highCrash = calculateCrashPoint(lowRandom, 0.97);
      log(`Low Random (${lowRandom}): Crash Point = <code>${highCrash.toFixed(2)}x</code>`);

      // High random value (should give low crash point)
      const highRandom = 0.9999;
      const lowCrash = calculateCrashPoint(highRandom, 0.97);
      log(`High Random (${highRandom}): Crash Point = <code>${lowCrash.toFixed(2)}x</code>`);

      log('<h2>Test 4: Verify Hash Determinism</h2>');

      const hash2 = await hashSeed(testSeed);
      if (hash === hash2) {
        log('✓ Hash is deterministic (same seed produces same hash)', 'success');
      } else {
        log('✗ Hash is not deterministic!', 'error');
      }

      log('<h2>Test Complete!</h2>', 'success');
      log('The calculation logic is working correctly. If you\'re seeing different values in the game, check that the RTP factor matches.');
    }

    runTest().catch(error => {
      log(`Error: ${error.message}`, 'error');
      console.error(error);
    });
  </script>
</body>
</html>
